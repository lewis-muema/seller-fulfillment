image: node:14.18.1

variables:
  STAGING_IMAGE_NAME: '${CI_REGISTRY}/seller-fulfillment:latest_${CI_COMMIT_SHORT_SHA}'
  STAGING_IMAGE_NAME_LATEST: sendy-docker-local.jfrog.io/seller-fulfillment:latest

stages:
  - lint
  - test
  - build
  - deploy

eslint:
  stage: lint
  tags:
    - docker
  script:
    - npm i eslint
    - npm run lint

test:
  image: cypress/base:14.16.0
  stage: test
  tags:
    - docker
  cache:
    paths:
      - .npm
      - /root/.cache/Cypress

  script:
    - npm ci --prefer-offline
    - npx cypress cache path
    - npx cypress cache list
    - npm run test

build:staging:
  stage: build
  tags:
    - shell
  script:
    - docker build --pull -t $STAGING_IMAGE_NAME -t $STAGING_IMAGE_NAME_LATEST -f Dockerfile .
    - docker push $STAGING_IMAGE_NAME
    - docker push $STAGING_IMAGE_NAME_LATEST
  only:
    - staging

# #deploys the app to staging environment
deploy:staging:
  stage: deploy
  tags:
    - shell
  script:
    - ssh -i ~/keys/id_rsa -f -o StrictHostKeyChecking=no -l admin kubetest-master.sendyit.com "kubectl set image deploy seller-fulfillment seller-fulfillment=${STAGING_IMAGE_NAME}"
  only:
    - staging
# buildpush:beta:
#   stage: buildpush
#   tags:
#     - shell
#   before_script:
#     - export BETA_FLUX_IMAGE_NAME="sendy-docker-local.jfrog.io/buyer-fulfillment:beta_$(date +%Y-%m-%d-%H-%M)"
#   script:
#     - docker build --build-arg DOCKER_ENV=beta --build=arg VUE_APP_OWNER_SEARCH="https://gate.sendyit.com/solr/owner/" VUE_APP_ENVIRONMENT="production" --build-arg VUE_APP_SENTRY_DSN="https://d017eeb1a2594094a9c30753d9e0b6bb@o32379.ingest.sentry.io/5922214" --build-arg VUE_APP_NODE_PRIVATE_URL="https://auth.sendyit.com/v1/" --build-arg VUE_APP_AUTH_URL="https://auth.sendyit.com/" --build-arg VUE_APP_ADONIS_URL="https://auth.sendyit.com/adonis/" --build-arg VUE_APP_CUSTOMERS_URL="https://auth.sendyit.com/customers/" --build-arg VUE_APP_PARTNERS_URL="https://auth.sendyit.com/partners/" --build-arg VUE_APP_ORDERS_URL="https://auth.sendyit.com/orders/" --pull -t $BETA_FLUX_IMAGE_NAME -f Dockerfile .
#     - docker push $BETA_FLUX_IMAGE_NAME
#   only:
#     - beta

#builds and pushes the docker image to the artifactory prod
# buildpush:prod:
#   stage: buildpush
#   tags:
#     - shell
#   before_script:
#     - export FLUX_IMAGE_NAME="sendy-docker-local.jfrog.io/buyer-fulfillment:prod_$(date +%Y-%m-%d-%H-%M)"
#   script:
#     - docker build --build-arg DOCKER_ENV=production --build-arg VUE_APP_OWNER_SEARCH="https://gate.sendyit.com/solr/owner/" --build-arg VUE_APP_ENVIRONMENT="production" --build-arg VUE_APP_SENTRY_DSN="https://d017eeb1a2594094a9c30753d9e0b6bb@o32379.ingest.sentry.io/5922214" --build-arg VUE_APP_NODE_PRIVATE_URL="https://auth.sendyit.com/v1/" --build-arg VUE_APP_AUTH_URL="https://auth.sendyit.com/" --build-arg VUE_APP_ADONIS_URL="https://auth.sendyit.com/adonis/" --build-arg VUE_APP_CUSTOMERS_URL="https://auth.sendyit.com/customers/" --build-arg VUE_APP_PARTNERS_URL="https://auth.sendyit.com/partners/" --build-arg VUE_APP_ORDERS_URL="https://auth.sendyit.com/orders/" --pull -t $FLUX_IMAGE_NAME -f Dockerfile .
#     - docker push $FLUX_IMAGE_NAME
#   only:
#     - master

build:preview_env:
  stage: build
  tags:
    - shell
  before_script:
    - export PREVIEW_ENV_IMAGE_NAME="sendy-docker-local.jfrog.io/seller-fulfillment:$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')_$(date +%Y-%m-%d-%H-%M)"
    - export FEATURE_ENV="$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')"
    - echo "$FEATURE_ENV"
  script:
    - docker build -t "${PREVIEW_ENV_IMAGE_NAME}" .
    - docker push h"${PREVIEW_ENV_IMAGE_NAME}
  only:
    refs:
      - /^feature*.*$/

create-preview-env:
  stage: deploy
  tags:
    - manta
  before_script:
    - export FEATURE="$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')"
  script:
    - pwd
    - source ~/.bash_profile && /opt/manta -c $FEATURE -f /home/ubuntu/.kube/config
  only:
    refs:
      - /^feature*.*$/
